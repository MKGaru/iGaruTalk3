<!DOCTYPE html>
<html>
<head>
  <title>iGaru Desktop Capture</title>
  <script src="https://skyway.io/dist/0.3/peer.js"></script>
</head>
<body>
<script>
var id = localStorage.getItem('id');
if(id == 'undefined' || id == 'null') id = null;
var peer = id
  ? new Peer(id , {key: 'c08e7ef5-80a6-40b7-9671-5156cbf83598'})
  : new Peer(     {key: 'c08e7ef5-80a6-40b7-9671-5156cbf83598'});
peer.on('error',function(err){
  if(err=='unavailable-id' || err=='invalid-id'){
    localStorage.removeItem('id');
    peer = new Peer({key: 'c08e7ef5-80a6-40b7-9671-5156cbf83598'});
  }
});
peer.on('open', function(id) {
  localStorage.setItem('id',id);
  var url = 'http://talk.igaru.com/share/#!/'+ id;
  var mediaConnections = [];
  var streams = [];
  var target = parent.postMessage ? parent : (parent.document.postMessage ? parent.document : undefined);
  if (typeof target != "undefined") {
    target.postMessage({ type:'url',value:url}, "*");
  }
  window.addEventListener('message', function(event) {
    var options = event.data;
    if(typeof options=='string'){
      options = {
        audio: { //Note: Audio desktop capture only supported in Chromium in WindowsOS 
          mandatory: {
              chromeMediaSource: "system",
              chromeMediaSourceId: options
           }
        },
        video: {
          mandatory: {
            chromeMediaSource: 'desktop', 
            chromeMediaSourceId: sourceId, 
            maxWidth: config.width, 
            maxHeight: config.height,
            minFrameRate: 30
          }, 
          optional: [
            { minFrameRate: 60 }
          ]
        }
      };
    }
    mediaConnections.forEach(function(mediaConnection){
      mediaConnection.close();
    });
    mediaConnections.splice(0,mediaConnections.length);
    streams.splice(0,streams.length);
    
    navigator.webkitGetUserMedia(
      options,
      function(stream){        
        streams.push(stream);
        for( var id in peer.connections ){
          if(peer.connections[id][0] && peer.connections[id][0].open )
            call(id,stream);
        }
      },
      function(err){
        console.error(err);
      }
    );
  },false);
  
  function call(id,stream){
    mediaConnections.push(
      peer.call(id,stream) 
    );
  }
  
  peer.on('connection', function(connection) {
    streams.forEach(function(stream){
      call(connection.peer,stream);
    });
  });
  
  setInterval(function(){
    var views = 0;
    for( var id in peer.connections ){
      if(peer.connections[id][0] && peer.connections[id][0].open ) views++;
    }
    if(target){
      target.postMessage({ type:'views',value:views }, "*");
    }
  },5000);
});
</script>
</body>
</html>
