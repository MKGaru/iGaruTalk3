<!DOCTYPE html>
<html>
<head>
  <title>iGaru Desktop Capture</title>
  <script src="https://cdn.webrtc.ecl.ntt.com/skyway-latest.js"></script>
</head>
<body>
<script>
var id = localStorage.getItem('id');
if(id == 'undefined' || id == 'null') id = null;
var peer = id
  ? new Peer(id , {key: 'ac6c0451-3f51-4e3d-b868-a2dfb409a6b1'})
  : new Peer(     {key: 'ac6c0451-3f51-4e3d-b868-a2dfb409a6b1'});
peer.on('error',function(err){
  if(err=='unavailable-id' || err=='invalid-id'){
    localStorage.removeItem('id');
    peer = new Peer({key: 'ac6c0451-3f51-4e3d-b868-a2dfb409a6b1'});
  }
});
peer.on('open', function(id) {
  localStorage.setItem('id',id);
  var url = 'https://talk.igaru.com/share/#!/'+ id;
  var mediaConnections = [];
  var streams = [];
  var target = parent.postMessage ? parent : (parent.document.postMessage ? parent.document : undefined);
  if (typeof target != "undefined") {
    target.postMessage({ type:'url',value:url}, "*");
  }
  window.addEventListener('message', function(event) {
    var options = event.data;

    mediaConnections.forEach(function(mediaConnection){
      mediaConnection.close();
    });
    mediaConnections.splice(0,mediaConnections.length);
    streams.splice(0,streams.length);
    
    // Application Capture Video/Sound
    navigator.webkitGetUserMedia(
      options,
      function(stream){
        function publish(){
          streams.push(stream);
          for( var id in peer.connections ){
            if(peer.connections[id][0] && peer.connections[id][0].open ){
              call(id,stream);
              peer.connections[id][0].send(options.title)
            }
          }
        }
        if(options.soundDevice && options.soundDevice!='application'){
          navigator.webkitGetUserMedia(
            {
              audio:{optional: [{sourceId: options.soundDevice}] }
            },function(stream2){
              stream.addTrack(stream2.getAudioTracks()[0]);
              publish();
            },function(err){
              console.error(err);
            }
          );
        }
        else{
          publish();
        }
      },
      function(err){
        console.error(err);
      }
    );
    // User Camera/Mic
    if( options.captureCamera || options.captureMic){
      navigator.webkitGetUserMedia(
        {
          video: options.captureCamera,
          audio: options.captureMic
        },function(stream){
          streams.push(stream);
          for( var id in peer.connections ){
            if(peer.connections[id][0] && peer.connections[id][0].open )
              call(id,stream);
          }
        },function(err){
          console.error(err);
        }
      );
    }
  },false);
  
  function call(id,stream){
    mediaConnections.push(
      peer.call(id,stream) 
    );
  }
  
  peer.on('connection', function(connection) {
    streams.forEach(function(stream){
      call(connection.peer,stream);
    });
  });
  
  setInterval(function(){
    var views = 0;
    for( var id in peer.connections ){
      if(peer.connections[id][0] && peer.connections[id][0].open ) views++;
    }
    if(target){
      target.postMessage({ type:'views',value:views }, "*");
    }
  },5000);
});
</script>
</body>
</html>
