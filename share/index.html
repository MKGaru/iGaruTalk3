<!DOCTYPE html>
<html>
<head>
  <title>iGaru Desktop Capture</title>
  <script src="https://skyway.io/dist/0.3/peer.js"></script>
  <style>
html{
  background: black;
}
video{
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  height: 100%;
  margin: 0 auto;
}
  </style>
</head>
<body>
<video id="video" autoplay controls></video>
<h1 style="text-align: center; color: white; position: relative; z-index: 1;display:none" id="unsupported">
  お使いのブラウザは、WebRTCによる映像再生に対応していません。<br>
  <a href="https://www.google.com/chrome/" target="_blank">Google Chrome</a>等でご利用ください。
</h1>
<script>
if(util.browser=='Unsupported'){
  document.getElementById('unsupported').style.display='block';
}
var peer = new Peer({key: 'c08e7ef5-80a6-40b7-9671-5156cbf83598'});
var remote = "";
var connection;
peer.on('open', function(id) {
  function connect(remote){
    connection = peer.connect(remote);
    connection.on('data',function(data){
      if(data)
        document.title = data + ' | iGaru Desktop Capture';
    });
    peer.on('call',function(call){
      call.answer();
      call.on('stream', function(stream) {
        if(stream.getVideoTracks().length){
          var video = document.getElementById('video');
          video.src = URL.createObjectURL(stream);
        }else{
           var video = document.getElementById('video');
          var audio = new Audio();
          audio.src = URL.createObjectURL(stream);
          audio.play();
          video.addEventListener('volumechange',function(){
            audio.volume = video.volume;
          },false);
          video.addEventListener('pause',function(){
            audio.pause();
          },false);
          video.addEventListener('play',function(){
            audio.play();
          },false);
        }
      });
    });
  }
  window.onhashchange = function(){
    if(location.hash.startsWith("#!/")) remote = location.hash.slice(3);
    connect(remote);
  };
  window.onhashchange();
  setInterval(function(){
    if(!connection.open){
      connect(remote);
    }
  },10000);
});
window.onbeforeunload = function(e) {
  peer.destroy();
}
</script>
</body>
</html>
